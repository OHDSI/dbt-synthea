models:
  - name: visit_occurrence
    description: >-
      This table contains Events where Persons engage with the healthcare system for a duration of
      time. They are often also called "Encounters". Visits are defined by a configuration of
      circumstances under which they occur, such as (i) whether the patient comes to a healthcare
      institution, the other way around, or the interaction is remote, (ii) whether and what kind of
      trained medical staff is delivering the service during the Visit, and (iii) whether the Visit
      is transient or for a longer period involving a stay in bed.

      ## User Guide

      The configuration defining the Visit are described by Concepts in the Visit Domain, which form
      a hierarchical structure, but rolling up to generally familiar Visits adopted in most
      healthcare systems worldwide:

        - [Inpatient Visit](https://athena.ohdsi.org/search-terms/terms/9201): Person visiting
      hospital, at a Care Site, in bed, for duration of more than one day, with physicians and other
      Providers permanently available to deliver service around the clock
        - [Emergency Room Visit](https://athena.ohdsi.org/search-terms/terms/9203): Person visiting
      dedicated healthcare institution for treating emergencies, at a Care Site, within one day,
      with physicians and Providers permanently available to deliver service around the clock
        - [Emergency Room and Inpatient Visit](https://athena.ohdsi.org/search-terms/terms/262):
      Person visiting ER followed by a subsequent Inpatient Visit, where Emergency department is
      part of hospital, and transition from the ER to other hospital departments is undefined
        - [Non-hospital institution Visit](https://athena.ohdsi.org/search-terms/terms/42898160):
      Person visiting dedicated institution for reasons of poor health, at a Care Site, long-term or
      permanently, with no physician but possibly other Providers permanently available to deliver
      service around the clock
        - [Outpatient Visit](https://athena.ohdsi.org/search-terms/terms/9202): Person visiting
      dedicated ambulatory healthcare institution, at a Care Site, within one day, without bed, with
      physicians or medical Providers delivering service during Visit
        - [Home Visit](https://athena.ohdsi.org/search-terms/terms/581476): Provider visiting
      Person, without a Care Site, within one day, delivering service
        - [Telehealth Visit](https://athena.ohdsi.org/search-terms/terms/5083): Patient engages with
      Provider through communication media
        - [Pharmacy Visit](https://athena.ohdsi.org/search-terms/terms/581458): Person visiting
      pharmacy for dispensing of Drug, at a Care Site, within one day
        - [Laboratory Visit](https://athena.ohdsi.org/search-terms/terms/32036): Patient visiting
      dedicated institution, at a Care Site, within one day, for the purpose of a Measurement.
        - [Ambulance Visit](https://athena.ohdsi.org/search-terms/terms/581478): Person using
      transportation service for the purpose of initiating one of the other Visits, without a Care
      Site, within one day, potentially with Providers accompanying the Visit and delivering service
        - [Case Management Visit](https://athena.ohdsi.org/search-terms/terms/38004193): Person
      interacting with healthcare system, without a Care Site, within a day, with no Providers
      involved, for administrative purposes

      The Visit duration, or 'length of stay', is defined as VISIT_END_DATE - VISIT_START_DATE. For
      all Visits this is <1 day, except Inpatient Visits and Non-hospital institution Visits. The
      CDM also contains the VISIT\_DETAIL table where additional information about the Visit is
      stored, for example, transfers between units during an inpatient Visit.
    columns:
      - name: visit_occurrence_id
        description:
          Use this to identify unique interactions between a person and the health care system. This
          identifier links across the other CDM event tables to associate events with a visit.
        data_type: bigint
        tests:
          - unique
          - not_null
      - name: person_id
        data_type: bigint
        tests:
          - not_null
          - relationships:
              field: person_id
              to: ref('person')
      - name: visit_concept_id
        description:
          This field contains a concept id representing the kind of visit, like inpatient or
          outpatient. All concepts in this field should be standard and belong to the Visit domain.
        data_type: integer
        tests:
          - not_null
          - dbt_utils.relationships_where:
              field: concept_id
              to: ref('concept')
              from_condition: visit_concept_id <> 0
              to_condition: domain_id = 'Visit'
      - name: visit_start_date
        description:
          For inpatient visits, the start date is typically the admission date. For outpatient
          visits the start date and end date will be the same.
        data_type: date
        tests:
          - not_null
      - name: visit_start_datetime
        data_type: timestamp
      - name: visit_end_date
        description:
          For inpatient visits the end date is typically the discharge date. If a Person is still an
          inpatient in the hospital at the time of the data extract and does not have a
          visit_end_date, then set the visit_end_date to the date of the data pull.
        data_type: date
        tests:
          - not_null
      - name: visit_end_datetime
        description:
          If a Person is still an inpatient in the hospital at the time of the data extract and does
          not have a visit_end_datetime, then set the visit_end_datetime to the datetime of the data
          pull.
        data_type: timestamp
      - name: visit_type_concept_id
        description:
          Use this field to understand the provenance of the visit record, or where the record comes
          from.
        data_type: integer
        tests:
          - not_null
          - dbt_utils.relationships_where:
              field: concept_id
              to: ref('concept')
              from_condition: visit_type_concept_id <> 0
              to_condition: domain_id = 'Type Concept'
      - name: provider_id
        description:
          There will only be one provider per visit record and the ETL document should clearly state
          how they were chosen (attending, admitting, etc.). If there are multiple providers
          associated with a visit in the source, this can be reflected in the event tables
          (CONDITION_OCCURRENCE, PROCEDURE_OCCURRENCE, etc.) or in the VISIT_DETAIL table.
        data_type: bigint
        tests:
          - relationships:
              field: provider_id
              to: ref('provider')
      - name: care_site_id
        description: This field provides information about the Care Site where the Visit took place.
        data_type: integer
        tests:
          - relationships:
              field: care_site_id
              to: ref('care_site')
      - name: visit_source_value
        description:
          This field houses the verbatim value from the source data representing the kind of visit
          that took place (inpatient, outpatient, emergency, etc.)
        data_type: varchar
      - name: visit_source_concept_id
        data_type: integer
        tests:
          - relationships:
              field: concept_id
              to: ref('concept')
      - name: admitted_from_concept_id
        description:
          Use this field to determine where the patient was admitted from. This concept is part of
          the visit domain and can indicate if a patient was admitted to the hospital from a
          long-term care facility, for example.
        data_type: integer
        tests:
          - dbt_utils.relationships_where:
              field: concept_id
              to: ref('concept')
              from_condition: admitted_from_concept_id <> 0
              to_condition: domain_id = 'Visit'
      - name: admitted_from_source_value
        data_type: integer
      - name: discharged_to_concept_id
        description:
          Use this field to determine where the patient was discharged to after a visit. This
          concept is part of the visit domain and can indicate if a patient was transferred to
          another hospital or sent to a long-term care facility, for example. It is assumed that a
          person is discharged to home therefore there is not a standard concept id for “home”. Use
          concept id = 0 when a person is discharged to home.
        data_type: integer
        tests:
          - dbt_utils.relationships_where:
              field: concept_id
              to: ref('concept')
              from_condition: discharged_to_concept_id <> 0
              to_condition: domain_id = 'Visit'
      - name: discharged_to_source_value
        data_type: integer
      - name: preceding_visit_occurrence_id
        description:
          Use this field to find the visit that occurred for the person prior to the given visit.
          There could be a few days or a few years in between.
        data_type: bigint
        tests:
          - relationships:
              field: visit_occurrence_id
              to: ref('visit_occurrence')
