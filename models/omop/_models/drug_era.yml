models:
  - name: drug_era
    description: 'A Drug Era is defined as a span of time when the Person is assumed to be exposed to
      a particular active ingredient. A Drug Era is not the same as a Drug Exposure: Exposures are individual
      records corresponding to the source when Drug was delivered to the Person, while successive periods
      of Drug Exposures are combined under certain rules to produce continuous Drug Eras. Every record
      in the DRUG_EXPOSURE table should be part of a drug era based on the dates of exposure.'
    tests:
      - person_completeness:
          threshold: '95'
    columns:
      - name: drug_era_id
        description: ''
        data_type: integer
        tests:
          - not_null
          - unique
          - dbt_expectations.expect_column_to_exist
          - dbt_expectations.expect_column_values_to_be_in_type_list:
              column_type_list: "{{ get_type_variants(['bigint', 'integer']) }}"
      - name: person_id
        description: ''
        data_type: integer
        tests:
          - not_null
          - relationships:
              to: ref('person')
              field: person_id
          - dbt_expectations.expect_column_to_exist
          - dbt_expectations.expect_column_values_to_be_in_type_list:
              column_type_list: "{{ get_type_variants(['bigint', 'integer']) }}"
      - name: drug_concept_id
        description: The drug_concept_id should conform to the concept class 'ingredient' as the drug_era
          is an era of time where a person is exposed to a particular drug ingredient.
        data_type: integer
        tests:
          - not_null
          - dbt_utils.relationships_where:
              to: ref('concept')
              field: concept_id
              from_condition: drug_concept_id <> 0
              to_condition: domain_id = 'Drug'
          - dbt_utils.relationships_where:
              to: ref('concept')
              field: concept_id
              from_condition: drug_concept_id <> 0
              to_condition: concept_class_id = 'Ingredient'
          - concept_record_completeness:
              threshold: '0'
          - dbt_expectations.expect_column_to_exist
          - dbt_expectations.expect_column_values_to_be_in_type_list:
              column_type_list: "{{ get_type_variants(['bigint', 'integer']) }}"
          - dbt_utils.relationships_where:
              to: ref('concept')
              field: concept_id
              from_condition: drug_concept_id != 0
              to_condition: standard_concept = 'S' AND invalid_reason IS NULL
      - name: drug_era_start_date
        description: ''
        data_type: date
        tests:
          - not_null
          - dbt_expectations.expect_column_to_exist
          - dbt_expectations.expect_column_values_to_be_in_type_list:
              column_type_list: "{{ get_equivalent_types('date') }}"
      - name: drug_era_end_date
        description: ''
        data_type: date
        tests:
          - not_null
          - dbt_expectations.expect_column_to_exist
          - dbt_expectations.expect_column_values_to_be_in_type_list:
              column_type_list: "{{ get_equivalent_types('date') }}"
      - name: drug_exposure_count
        description: The count of grouped DRUG_EXPOSURE records that were included in the DRUG_ERA row
        data_type: integer
        tests:
          - dbt_expectations.expect_column_to_exist
          - dbt_expectations.expect_column_values_to_be_in_type_list:
              column_type_list: "{{ get_type_variants(['bigint', 'integer']) }}"
      - name: gap_days
        description: ''
        data_type: integer
        tests:
          - dbt_expectations.expect_column_to_exist
          - dbt_expectations.expect_column_values_to_be_in_type_list:
              column_type_list: "{{ get_type_variants(['bigint', 'integer']) }}"
